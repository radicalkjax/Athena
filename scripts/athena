#!/bin/bash
# Athena CLI - Enhanced Unified Launcher
# A beautiful, comprehensive startup script with transgender pride colors

# Set text colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
WHITE='\033[1;37m'
NC='\033[0m' # No Color

# Visual elements
BOLD='\033[1m'
DIM='\033[2m'
UNDERLINE='\033[4m'

# Transgender flag colors
TRANS_BLUE='\033[38;2;91;206;250m'    # Light Blue
TRANS_PINK='\033[38;2;245;169;184m'   # Pink
TRANS_WHITE='\033[38;2;255;255;255m'  # White

# Unicode characters
CHECK_MARK='âœ“'
CROSS_MARK='âœ—'
WARNING_SIGN='âš '
GEAR='âš™'
ROCKET='ğŸš€'
PACKAGE='ğŸ“¦'
TOOL='ğŸ”§'
SPARKLES='âœ¨'
KEY='ğŸ”‘'
SHIELD='ğŸ›¡ï¸'
HEART='â™¥'

# Print enhanced banner
print_banner() {
    clear
    echo
    echo -e "${TRANS_BLUE}  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— ${NC}"
    echo -e "${TRANS_PINK} â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—${NC}"
    echo -e "${TRANS_WHITE} â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘${NC}"
    echo -e "${TRANS_PINK} â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘${NC}"
    echo -e "${TRANS_BLUE} â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘${NC}"
    echo -e "${TRANS_WHITE} â•šâ•â•  â•šâ•â•   â•šâ•â•   â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â•â•â•â•šâ•â•  â•šâ•â•${NC}"
    echo
    echo -e "${TRANS_PINK}${BOLD}AI-Powered Malware Analysis Assistant${NC}"
    echo -e "${TRANS_BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${TRANS_WHITE}ğŸ³ï¸â€âš§ï¸ Made with love ${TRANS_PINK}â™¥${TRANS_WHITE} Open source for all ğŸ³ï¸â€âš§ï¸${NC}"
    echo -e "${TRANS_BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo
}

# Interactive menu
show_menu() {
    echo -e "${TRANS_BLUE}${BOLD}Main Menu${NC}"
    echo -e "${TRANS_PINK}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${YELLOW}ğŸ’¡ Tip: For the full malware analysis platform, use Option 1${NC}"
    echo
    echo -e "${TRANS_WHITE}${BOLD}Quick Start:${NC}"
    echo -e "  ${GREEN}1${NC}) ${ROCKET} Start Athena API Platform"
    echo -e "  ${GREEN}2${NC}) ${KEY} Check API Keys"
    echo -e "  ${GREEN}3${NC}) ${PACKAGE} Update Everything"
    echo
    echo -e "${TRANS_WHITE}${BOLD}Frontend Development:${NC}"
    echo -e "  ${GREEN}4${NC}) ğŸŒ Start React Native Web ${DIM}(UI only)${NC}"
    echo -e "  ${GREEN}5${NC}) ğŸ“± Start iOS Version"
    echo -e "  ${GREEN}6${NC}) ğŸ¤– Start Android Version"
    echo -e "  ${GREEN}7${NC}) ğŸ“² Start Expo Development"
    echo
    echo -e "${TRANS_WHITE}${BOLD}Maintenance:${NC}"
    echo -e "  ${GREEN}8${NC}) ${TOOL} Run Setup"
    echo -e "  ${GREEN}9${NC}) ğŸ§¹ Clean Build Files"
    echo -e "  ${GREEN}10${NC}) ${SHIELD} Security Audit"
    echo -e "  ${GREEN}11${NC}) ğŸ—„ï¸  Database Setup"
    echo
    echo -e "${TRANS_WHITE}${BOLD}Backend Services:${NC}"
    echo -e "  ${GREEN}12${NC}) ğŸš€ Launch Platform (Docker)"
    echo -e "  ${GREEN}13${NC}) ğŸ–¥ï¸  Start Local Services"
    echo -e "  ${GREEN}14${NC}) ğŸ“Š Run Load Tests"
    echo
    echo -e "${TRANS_WHITE}${BOLD}Testing:${NC}"
    echo -e "  ${GREEN}15${NC}) ğŸ§ª Run All Tests"
    echo -e "  ${GREEN}16${NC}) ğŸ’ª Run Stress Test (1000+ RPS)"
    echo
    echo -e "${DIM}Type 'h' for help, 'q' to quit${NC}"
    echo
}

# Quick system check
quick_check() {
    echo -e "${TRANS_WHITE}${GEAR} Quick System Check...${NC}"

    # Check Node.js
    if command -v node &> /dev/null; then
        NODE_VERSION=$(node -v)
        echo -e "  ${GREEN}${CHECK_MARK}${NC} Node.js ${DIM}${NODE_VERSION}${NC}"
    else
        echo -e "  ${RED}${CROSS_MARK}${NC} Node.js not found"
    fi

    # Check npm
    if command -v npm &> /dev/null; then
        NPM_VERSION=$(npm -v)
        echo -e "  ${GREEN}${CHECK_MARK}${NC} npm ${DIM}${NPM_VERSION}${NC}"
    else
        echo -e "  ${RED}${CROSS_MARK}${NC} npm not found"
    fi

    # Check if in correct directory
    if [ -d "Athena" ]; then
        echo -e "  ${GREEN}${CHECK_MARK}${NC} Athena directory found"
    else
        echo -e "  ${RED}${CROSS_MARK}${NC} Not in Athena root directory"
        return 1
    fi

    # Check for .env file
    if [ -f "Athena/.env" ]; then
        echo -e "  ${GREEN}${CHECK_MARK}${NC} Environment configured"
    else
        echo -e "  ${YELLOW}${WARNING_SIGN}${NC} No .env file (run API key check)"
    fi

    echo
    return 0
}

# Run security audit
run_security_audit() {
    echo -e "${TRANS_BLUE}${SHIELD} ${BOLD}Security Audit${NC}"
    echo -e "${TRANS_PINK}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo

    cd Athena
    echo -e "${TRANS_WHITE}Running npm audit...${NC}"
    npm audit

    echo
    echo -e "${TRANS_WHITE}Checking for exposed secrets...${NC}"
    if command -v git &> /dev/null; then
        # Check for common secret patterns
        git grep -i -E "(api[_-]?key|secret|password|token)" --cached | grep -v -E "(\.md|\.txt|\.example|test)" | head -10
        if [ $? -eq 0 ]; then
            echo -e "${YELLOW}${WARNING_SIGN} Potential secrets found in code${NC}"
        else
            echo -e "${GREEN}${CHECK_MARK} No obvious secrets in code${NC}"
        fi
    fi

    cd ..
    echo
    echo -e "${DIM}Press Enter to continue...${NC}"
    read
}

# Run all tests
run_all_tests() {
    echo -e "${TRANS_BLUE}ğŸ§ª ${BOLD}Running Test Suite${NC}"
    echo -e "${TRANS_PINK}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo

    cd Athena

    echo -e "${TRANS_WHITE}1. Unit Tests${NC}"
    npm run test:unit

    echo -e "\n${TRANS_WHITE}2. Integration Tests${NC}"
    npm run test:integration

    echo -e "\n${TRANS_WHITE}3. Component Tests${NC}"
    npm run test:components

    cd ..
    echo
    echo -e "${DIM}Press Enter to continue...${NC}"
    read
}

# Main execution loop
main() {
    print_banner

    if ! quick_check; then
        echo -e "${RED}Please run this script from the Athena repository root${NC}"
        exit 1
    fi

    while true; do
        show_menu

        echo -e -n "${TRANS_BLUE}Select an option: ${NC}"
        read choice

        case $choice in
            1)
                echo -e "\n${ROCKET} Starting Athena API Platform..."
                ./scripts/launch-athena.sh
                ;;
            2)
                echo -e "\n${KEY} Checking API Keys..."
                node scripts/check-api-keys.js
                echo -e "${DIM}Press Enter to continue...${NC}"
                read
                ;;
            3)
                echo -e "\n${PACKAGE} Updating Everything..."
                ./scripts/run.sh update
                echo -e "${DIM}Press Enter to continue...${NC}"
                read
                ;;
            4)
                echo -e "\nğŸŒ Starting React Native Web UI..."
                ./scripts/start-web-ui.sh
                ;;
            5)
                echo -e "\nğŸ“± Starting iOS Version..."
                ./scripts/run.sh ios
                ;;
            6)
                echo -e "\nğŸ¤– Starting Android Version..."
                ./scripts/run.sh android
                ;;
            7)
                echo -e "\nğŸ“² Starting Expo Development..."
                ./scripts/run.sh expo
                ;;
            8)
                echo -e "\n${TOOL} Running Setup..."
                ./scripts/run.sh setup
                echo -e "${DIM}Press Enter to continue...${NC}"
                read
                ;;
            9)
                echo -e "\nğŸ§¹ Cleaning Build Files..."
                ./scripts/run.sh clean
                echo -e "${DIM}Press Enter to continue...${NC}"
                read
                ;;
            10)
                run_security_audit
                ;;
            11)
                echo -e "\nğŸ—„ï¸  Setting up Database..."
                cd Athena && ./scripts/setup-db.sh
                cd ..
                echo -e "${DIM}Press Enter to continue...${NC}"
                read
                ;;
            12)
                echo -e "\nğŸš€ Launching Platform with Docker..."
                ./scripts/launch-athena.sh
                ;;
            13)
                echo -e "\nğŸ–¥ï¸  Starting Local Services..."
                ./scripts/start-all-services.sh
                ;;
            14)
                echo -e "\nğŸ“Š Running Load Tests..."
                ./scripts/run-load-test.sh
                echo -e "${DIM}Press Enter to continue...${NC}"
                read
                ;;
            15)
                run_all_tests
                ;;
            16)
                echo -e "\nğŸ’ª Running Stress Test..."
                ./scripts/run-stress-test.sh
                echo -e "${DIM}Press Enter to continue...${NC}"
                read
                ;;
            h|H)
                ./scripts/run.sh help
                echo -e "${DIM}Press Enter to continue...${NC}"
                read
                ;;
            q|Q)
                echo -e "\n${TRANS_WHITE}${SPARKLES} Thanks for using Athena! ${SPARKLES}${NC}"
                echo -e "${TRANS_PINK}Stay safe and analyze with pride! ğŸ³ï¸â€âš§ï¸${NC}\n"
                exit 0
                ;;
            *)
                echo -e "${RED}Invalid option. Please try again.${NC}"
                sleep 1
                ;;
        esac

        clear
        print_banner
    done
}

# Check if we're in the right directory
if [ ! -d "Athena" ]; then
    echo -e "${RED}${CROSS_MARK} Athena directory not found${NC}"
    echo -e "${YELLOW}Please run from repository root${NC}"
    exit 1
fi

# Handle Ctrl+C gracefully
trap 'echo -e "\n\n${YELLOW}${WARNING_SIGN} Operation cancelled${NC}"; exit 0' INT

# Run main function
main
