<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Athena WASM Analysis Engine Test</title>
    <style>
        body {
            font-family: monospace;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1e1e1e;
            color: #e0e0e0;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .panel {
            background-color: #2d2d2d;
            border: 1px solid #444;
            border-radius: 5px;
            padding: 15px;
        }
        h1, h2 {
            color: #61dafb;
        }
        textarea {
            width: 100%;
            height: 200px;
            background-color: #1e1e1e;
            color: #e0e0e0;
            border: 1px solid #444;
            border-radius: 3px;
            padding: 10px;
            font-family: monospace;
        }
        button {
            background-color: #61dafb;
            color: #1e1e1e;
            border: none;
            padding: 10px 20px;
            border-radius: 3px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
        }
        button:hover {
            background-color: #4fa8c5;
        }
        .results {
            background-color: #1e1e1e;
            border: 1px solid #444;
            border-radius: 3px;
            padding: 10px;
            margin-top: 10px;
            max-height: 400px;
            overflow-y: auto;
        }
        .threat {
            background-color: #3d2d2d;
            border-left: 3px solid #ff6b6b;
            padding: 10px;
            margin: 5px 0;
        }
        .critical { border-left-color: #ff0000; }
        .high { border-left-color: #ff6b6b; }
        .medium { border-left-color: #ffa500; }
        .low { border-left-color: #ffff00; }
        .safe { border-left-color: #00ff00; }
    </style>
</head>
<body>
    <h1>Athena WASM Analysis Engine Test</h1>
    
    <div class="container">
        <div class="panel">
            <h2>Input</h2>
            <textarea id="input" placeholder="Paste suspicious code here...">
// Example 1: Base64 obfuscated JavaScript
eval(atob('YWxlcnQoIlhTUyBBdHRhY2shIik='));

// Example 2: Hex encoded strings
var payload = "\x65\x76\x61\x6c";

// Example 3: Dynamic script injection
document.write("<script>alert('injected')</script>");

// Example 4: Character code obfuscation
String.fromCharCode(97,108,101,114,116,40,39,72,97,99,107,101,100,33,39,41);
            </textarea>
            
            <button onclick="analyzeContent()">Analyze Content</button>
            <button onclick="deobfuscateContent()">Deobfuscate Only</button>
            <button onclick="scanPatterns()">Scan Patterns Only</button>
            <button onclick="clearResults()">Clear</button>
        </div>
        
        <div class="panel">
            <h2>Analysis Results</h2>
            <div id="results" class="results">
                <p>Click "Analyze Content" to start...</p>
            </div>
        </div>
    </div>
    
    <div class="panel" style="margin-top: 20px;">
        <h2>Deobfuscated Content</h2>
        <div id="deobfuscated" class="results">
            <p>Deobfuscated content will appear here...</p>
        </div>
    </div>

    <script type="module">
        import init, { AnalysisEngine } from '../core/analysis-engine/pkg-web/athena_analysis_engine.js';
        
        let engine = null;
        
        async function initialize() {
            await init();
            engine = new AnalysisEngine();
            console.log(`Athena Analysis Engine v${engine.get_version()} loaded`);
        }
        
        window.analyzeContent = async function() {
            if (!engine) {
                await initialize();
            }
            
            const input = document.getElementById('input').value;
            const encoder = new TextEncoder();
            const inputBytes = encoder.encode(input);
            
            try {
                const result = await engine.analyze(inputBytes, {});
                displayAnalysisResults(result);
            } catch (error) {
                console.error('Analysis error:', error);
                document.getElementById('results').innerHTML = `<p style="color: #ff6b6b;">Error: ${error}</p>`;
            }
        };
        
        window.deobfuscateContent = async function() {
            if (!engine) {
                await initialize();
            }
            
            const input = document.getElementById('input').value;
            
            try {
                const result = await engine.deobfuscate(input);
                displayDeobfuscationResults(result);
            } catch (error) {
                console.error('Deobfuscation error:', error);
                document.getElementById('deobfuscated').innerHTML = `<p style="color: #ff6b6b;">Error: ${error}</p>`;
            }
        };
        
        window.scanPatterns = async function() {
            if (!engine) {
                await initialize();
            }
            
            const input = document.getElementById('input').value;
            const encoder = new TextEncoder();
            const inputBytes = encoder.encode(input);
            
            try {
                const matches = await engine.scan_patterns(inputBytes);
                displayPatternMatches(matches);
            } catch (error) {
                console.error('Pattern scan error:', error);
                document.getElementById('results').innerHTML = `<p style="color: #ff6b6b;">Error: ${error}</p>`;
            }
        };
        
        window.clearResults = function() {
            document.getElementById('results').innerHTML = '<p>Cleared</p>';
            document.getElementById('deobfuscated').innerHTML = '<p>Cleared</p>';
        };
        
        function displayAnalysisResults(result) {
            const resultsDiv = document.getElementById('results');
            let html = `
                <h3 class="${result.severity}">Severity: ${result.severity.toUpperCase()}</h3>
                <p><strong>File Hash:</strong> ${result.metadata.file_hash}</p>
                <p><strong>Analysis Time:</strong> ${result.metadata.analysis_time_ms}ms</p>
                <p><strong>Engine Version:</strong> ${result.metadata.engine_version}</p>
            `;
            
            if (result.threats && result.threats.length > 0) {
                html += '<h4>Threats Detected:</h4>';
                result.threats.forEach(threat => {
                    html += `
                        <div class="threat">
                            <strong>${threat.threat_type}</strong> (Confidence: ${(threat.confidence * 100).toFixed(0)}%)
                            <p>${threat.description}</p>
                            <ul>
                                ${threat.indicators.map(ind => `<li>${ind}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                });
            } else {
                html += '<p style="color: #00ff00;">No threats detected</p>';
            }
            
            resultsDiv.innerHTML = html;
            
            if (result.deobfuscated_content) {
                document.getElementById('deobfuscated').innerHTML = `
                    <h4>Deobfuscated Content Found:</h4>
                    <pre>${escapeHtml(result.deobfuscated_content)}</pre>
                `;
            }
        }
        
        function displayDeobfuscationResults(result) {
            const deobDiv = document.getElementById('deobfuscated');
            let html = `
                <h4>Deobfuscation Results</h4>
                <p><strong>Confidence:</strong> ${(result.confidence * 100).toFixed(0)}%</p>
            `;
            
            if (result.techniques_found && result.techniques_found.length > 0) {
                html += '<p><strong>Techniques Found:</strong></p><ul>';
                result.techniques_found.forEach(tech => {
                    html += `<li>${JSON.stringify(tech)}</li>`;
                });
                html += '</ul>';
            }
            
            html += `
                <h4>Original:</h4>
                <pre>${escapeHtml(result.original)}</pre>
                <h4>Deobfuscated:</h4>
                <pre>${escapeHtml(result.deobfuscated)}</pre>
            `;
            
            deobDiv.innerHTML = html;
        }
        
        function displayPatternMatches(matches) {
            const resultsDiv = document.getElementById('results');
            
            if (!matches || matches.length === 0) {
                resultsDiv.innerHTML = '<p style="color: #00ff00;">No patterns matched</p>';
                return;
            }
            
            let html = '<h4>Pattern Matches:</h4>';
            matches.forEach(match => {
                html += `
                    <div class="threat ${match.pattern.severity.toLowerCase()}">
                        <strong>${match.pattern.name}</strong> (${match.pattern.category})
                        <p>${match.pattern.description}</p>
                        <p><strong>Severity:</strong> ${match.pattern.severity}</p>
                        <p><strong>Offset:</strong> ${match.offset} (Length: ${match.length})</p>
                        <p><strong>Context:</strong></p>
                        <pre>${escapeHtml(match.context)}</pre>
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = html;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Initialize on load
        initialize().catch(console.error);
    </script>
</body>
</html>