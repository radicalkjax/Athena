var w=Object.defineProperty;var b=(h,e,s)=>e in h?w(h,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):h[e]=s;var c=(h,e,s)=>b(h,typeof e!="symbol"?e+"":e,s);import{i as P}from"./index-C4Q2lgHl.js";class z{constructor(e,s={}){c(this,"queue",[]);c(this,"processing",!1);c(this,"batchSize");c(this,"delay");c(this,"processFn");c(this,"timer",null);this.processFn=e,this.batchSize=s.batchSize||50,this.delay=s.delay||100}add(e){this.queue.push(e),this.scheduleProcess()}addMany(e){this.queue.push(...e),this.scheduleProcess()}scheduleProcess(){this.timer===null&&(this.timer=window.setTimeout(()=>{this.timer=null,this.process()},this.delay))}async process(){if(!(this.processing||this.queue.length===0)){for(this.processing=!0;this.queue.length>0;){const e=this.queue.splice(0,this.batchSize);await this.processFn(e)}this.processing=!1}}flush(){return this.timer!==null&&(clearTimeout(this.timer),this.timer=null),this.process()}}class T{constructor(e=300*1e3){c(this,"cache",new Map);c(this,"defaultTTL");this.defaultTTL=e}set(e,s,t){const i=Date.now()+(t||this.defaultTTL);this.cache.set(e,{value:s,expiry:i})}get(e){const s=this.cache.get(e);if(s){if(Date.now()>s.expiry){this.cache.delete(e);return}return s.value}}has(e){return this.get(e)!==void 0}delete(e){this.cache.delete(e)}clear(){this.cache.clear()}cleanup(){const e=Date.now();for(const[s,t]of this.cache.entries())e>t.expiry&&this.cache.delete(s)}}class R{constructor(){c(this,"providers",new Map);c(this,"activeRequests",new Map);c(this,"requestCache",new T(600*1e3));c(this,"batchProcessor");c(this,"requestQueue",new Map);this.initializeProviders(),this.batchProcessor=new z(async e=>{const s=e.map(async t=>{try{const i=await this.processSingleRequest(t),r=this.requestQueue.get(t.analysisId);r&&(r(i),this.requestQueue.delete(t.analysisId))}catch(i){console.error("Batch processing error:",i)}});await Promise.all(s)},{batchSize:5,delay:200})}initializeProviders(){[{id:"claude",name:"Claude 3",enabled:!0,model:"claude-3-opus-20240229",maxTokens:4e3,temperature:.2},{id:"gpt4",name:"GPT-4",enabled:!0,model:"gpt-4-turbo-preview",maxTokens:4e3,temperature:.2},{id:"deepseek",name:"DeepSeek",enabled:!0,model:"deepseek-coder",maxTokens:4e3,temperature:.2},{id:"gemini",name:"Gemini Pro",enabled:!0,model:"gemini-pro",maxTokens:4e3,temperature:.2},{id:"mistral",name:"Mistral",enabled:!0,model:"mistral-large-latest",maxTokens:4e3,temperature:.2},{id:"llama",name:"Llama 3",enabled:!0,model:"llama-3-70b",maxTokens:4e3,temperature:.2}].forEach(s=>{this.providers.set(s.id,s)})}async analyzeWithProvider(e,s){const t=`${e}-${s.fileHash}-${s.analysisType||"comprehensive"}`,i=this.requestCache.get(t);if(i)return i;const r=this.providers.get(e);if(!r||!r.enabled)throw new Error(`Provider ${e} is not available or enabled`);const a=`${e}-${s.fileHash}-${Date.now()}`,n=new AbortController;this.activeRequests.set(a,n);try{const l={provider:r.id,model:r.model,api_key:"",max_tokens:r.maxTokens,temperature:r.temperature},u={...await P("analyze_with_ai",{provider:e,config:l,request:{file_hash:s.fileHash,file_path:s.filePath,file_type:s.fileType,analysis_type:s.analysisType||"comprehensive",content:s.content}}),provider:e,timestamp:Date.now()};return this.requestCache.set(t,u),u}catch(l){throw console.error(`AI analysis failed for ${e}:`,l),l}finally{this.activeRequests.delete(a)}}async processSingleRequest(e){const s=Array.from(this.providers.entries()).filter(([i,r])=>r.enabled).map(([i])=>i);if(s.length===0)throw new Error("No AI providers available");const t=s[0];if(!t)throw new Error("No AI providers available");return this.analyzeWithProvider(t,e)}async analyzeWithMultipleProviders(e){const t=e.providers.filter(i=>{const r=this.providers.get(i);return r&&r.enabled}).map(i=>this.analyzeWithProvider(i,e).catch(r=>({provider:i,timestamp:Date.now(),confidence:0,threatLevel:"safe",signatures:[],behaviors:[],iocs:{domains:[],ips:[],files:[],registry:[],processes:[]},recommendations:[],error:r.message})));return Promise.all(t)}async analyzeWithMultipleProvidersWithProgress(e,s){const t=e.providers.filter(a=>{const n=this.providers.get(a);return n&&n.enabled}),i=[],r=t.length;for(let a=0;a<t.length;a++){const n=t[a];if(!n)continue;const l=a/r*100;s&&s(n,l);try{const d=await this.analyzeWithProvider(n,e);i.push(d),s&&s(n,(a+1)/r*100)}catch(d){i.push({provider:n,timestamp:Date.now(),confidence:0,threatLevel:"safe",signatures:[],behaviors:[],iocs:{domains:[],ips:[],files:[],registry:[],processes:[]},recommendations:[],error:d.message})}}return i}cancelAnalysis(e){for(const[s,t]of this.activeRequests.entries())s.includes(e)&&(t.abort(),this.activeRequests.delete(s))}getProviderStatus(e){const s=this.providers.get(e);return s?s.enabled:!1}updateProviderConfig(e,s){const t=this.providers.get(e);t&&this.providers.set(e,{...t,...s})}getAllProviders(){return Array.from(this.providers.values())}async analyzeWithEnsemble(e,s="voting",t){switch(s){case"single-fallback":return this.singleWithFallback(e,t);case"voting":return this.ensembleVoting(e,t);case"sequential":return this.sequentialEnhancement(e,t);case"specialized":return this.specializedRouting(e,t);default:return this.ensembleVoting(e,t)}}async singleWithFallback(e,s){const t=e.providers[0]??"claude";try{const i=await this.analyzeWithProvider(t,e);return{consensus:i,individual:[i]}}catch{for(const r of e.providers.slice(1))try{const a=await this.analyzeWithProvider(r,e);return{consensus:a,individual:[a]}}catch{continue}throw new Error("All providers failed")}}async ensembleVoting(e,s){var p,y,v;const t=await this.analyzeWithMultipleProvidersWithProgress(e,s),i=new Map,r=new Map,a=new Set,n=new Set;let l=0,d=0;t.forEach(o=>{if(o.confidence>0){d++,l+=o.confidence;const m=o.confidence;i.set(o.threatLevel,(i.get(o.threatLevel)||0)+m),o.malwareFamily&&r.set(o.malwareFamily,(r.get(o.malwareFamily)||0)+m),o.signatures.forEach(f=>a.add(f)),o.behaviors.forEach(f=>n.add(f))}});const u=((p=[...i.entries()].sort((o,m)=>m[1]-o[1])[0])==null?void 0:p[0])??"safe",g=(y=[...r.entries()].sort((o,m)=>m[1]-o[1])[0])==null?void 0:y[0];return{consensus:{provider:"ensemble",timestamp:Date.now(),confidence:d>0?l/d:0,threatLevel:u,malwareFamily:g,malwareType:(v=t[0])==null?void 0:v.malwareType,signatures:Array.from(a),behaviors:Array.from(n),iocs:this.mergeIOCs(t),recommendations:this.generateRecommendations(u)},individual:t}}async sequentialEnhancement(e,s){const t=[];let i={...e};for(let a=0;a<e.providers.length;a++){const n=e.providers[a];if(!n)continue;const l=a/e.providers.length*100;s&&s(n,l);const d=await this.analyzeWithProvider(n,i);t.push(d),s&&s(n,(a+1)/e.providers.length*100),i={...i,content:`${i.content}

Previous analysis:
${JSON.stringify(d,null,2)}`}}const r=t[t.length-1];if(!r)throw new Error("No analysis results generated");return{consensus:r,individual:t}}async specializedRouting(e,s){const i={pe:["claude","gpt4"],elf:["deepseek","mistral"],macho:["gemini","llama"],script:["gpt4","claude"],document:["gemini","gpt4"]}[e.fileType]||e.providers,r={...e,providers:i};return this.ensembleVoting(r,s)}mergeIOCs(e){const s={domains:new Set,ips:new Set,files:new Set,registry:new Set,processes:new Set};return e.forEach(t=>{t.iocs.domains.forEach(i=>s.domains.add(i)),t.iocs.ips.forEach(i=>s.ips.add(i)),t.iocs.files.forEach(i=>s.files.add(i)),t.iocs.registry.forEach(i=>s.registry.add(i)),t.iocs.processes.forEach(i=>s.processes.add(i))}),{domains:Array.from(s.domains),ips:Array.from(s.ips),files:Array.from(s.files),registry:Array.from(s.registry),processes:Array.from(s.processes)}}generateRecommendations(e){return{safe:["File appears benign","Continue monitoring for behavioral changes","Maintain regular security scans"],suspicious:["Isolate file for further analysis","Run in controlled sandbox environment","Check for similar samples in threat databases","Monitor system for unusual behavior"],malicious:["Immediately isolate infected system","Run comprehensive malware removal","Check network for lateral movement","Review security logs for indicators of compromise","Update security signatures and rules"],critical:["CRITICAL: Disconnect system from network immediately","Initiate incident response procedures","Preserve system state for forensic analysis","Check all connected systems for compromise","Notify security team and management","Consider full system rebuild after analysis"]}[e]}}const W=new R;export{W as a};
